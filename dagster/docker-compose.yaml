services:
  dagster-webserver:
    build: .
    ports:
      - "3000:3000"
    restart: unless-stopped
    environment:
      - DAGSTER_HOME=/app/dagster_home
      - LAKEHOUSE_BACKEND=${LAKEHOUSE_BACKEND:-aws-glue}
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - AWS_PROFILE=${AWS_PROFILE:-default}
    volumes:
      - ./lakehouse:/app/lakehouse
      - dagster-storage:/app/dagster_home
      - ~/.aws:/home/dagster/.aws:ro
    command: dagster-webserver -h 0.0.0.0 -p 3000
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/server_info"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 2G

  dagster-daemon:
    build: .
    restart: unless-stopped
    environment:
      - DAGSTER_HOME=/app/dagster_home
      - LAKEHOUSE_BACKEND=${LAKEHOUSE_BACKEND:-aws-glue}
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - AWS_PROFILE=${AWS_PROFILE:-default}
    volumes:
      - ./lakehouse:/app/lakehouse
      - dagster-storage:/app/dagster_home
      - ~/.aws:/home/dagster/.aws:ro
    command: dagster-daemon run
    depends_on:
      dagster-webserver:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 1G

volumes:
  dagster-storage:
